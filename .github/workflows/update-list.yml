name: Update GroupPolicy Package List

on:
  schedule:
    # æ¯é€±æœˆæ›œæ—¥ã®åˆå‰9æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œï¼ˆUTC 0:00ï¼‰
    - cron: '0 0 * * 1'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½ã«ã™ã‚‹

jobs:
  update-list:
    runs-on: windows-latest

    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update GroupPolicy package list
        shell: cmd
        run: |
          echo Updating GroupPolicy package list...
          dir /b %SystemRoot%\servicing\Packages\Microsoft-Windows-GroupPolicy-ClientExtensions-Package~3*.mum >List.txt
          dir /b %SystemRoot%\servicing\Packages\Microsoft-Windows-GroupPolicy-ClientTools-Package~3*.mum >>List.txt

      - name: Check for changes
        id: check_changes
        shell: bash
        run: |
          git diff --quiet List.txt || echo "changed=true" >> $GITHUB_OUTPUT

      - name: Get changes details
        if: steps.check_changes.outputs.changed == 'true'
        id: get_changes
        shell: bash
        run: |
          echo "å¤‰æ›´ã®è©³ç´°ã‚’å–å¾—..."
          git diff List.txt > changes.diff
          cat changes.diff

      - name: Commit and push if changed
        if: steps.check_changes.outputs.changed == 'true'
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add List.txt
          git commit -m "chore: update GroupPolicy package list

          ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

          Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
          git push

      - name: Create notification issue
        if: steps.check_changes.outputs.changed == 'true'
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # å¤‰æ›´æ—¥æ™‚ã‚’å–å¾—
          CURRENT_DATE=$(date +'%Y-%m-%d')

          # å¤‰æ›´å†…å®¹ã‚’å–å¾—
          DIFF_OUTPUT=$(git diff HEAD~1 List.txt)

          # è¿½åŠ ã•ã‚ŒãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
          ADDED=$(echo "$DIFF_OUTPUT" | grep "^+" | grep -v "^+++" | sed 's/^+//' || echo "ãªã—")

          # å‰Šé™¤ã•ã‚ŒãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
          REMOVED=$(echo "$DIFF_OUTPUT" | grep "^-" | grep -v "^---" | sed 's/^-//' || echo "ãªã—")

          # Issueæœ¬æ–‡ã‚’ä½œæˆ
          ISSUE_BODY="## GroupPolicy ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒªã‚¹ãƒˆãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ

### æ›´æ–°æ—¥æ™‚
${CURRENT_DATE}

### è¿½åŠ ã•ã‚ŒãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
\`\`\`
${ADDED}
\`\`\`

### å‰Šé™¤ã•ã‚ŒãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
\`\`\`
${REMOVED}
\`\`\`

### å¤‰æ›´ã®è©³ç´°
ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}
ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

---
ğŸ¤– ã“ã®Issueã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ"

          # Issueã‚’ä½œæˆ
          gh issue create \
            --title "GroupPolicy ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒªã‚¹ãƒˆæ›´æ–°é€šçŸ¥ (${CURRENT_DATE})" \
            --body "$ISSUE_BODY" \
            --label "automated,update"
